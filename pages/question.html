<script>
var question = questions.find(i => i.uniqid==message.quid);
question.isNew = "";
if(!question) {
	question = {};
	["after","hint","answer","name","question","transport"].forEach(i => question[i] = "");
	/* nastavuje se v Nastav souřadnice, odkomentovat pro nastavení výchozích na aktuální pozici
		GPS().then(gps => ["lat","lng"].forEach(i => question[i] = gps[i]));
	*/
	question.radius = 20;
	question.type = "TEXT";
	question.url = localStorage.getItem("gameLogin");
	question.uniqid = uniqid();
	question.isNew = true;
}
</script>
<div class="center">
	<div id="pic" style="height: 480px"></div>
	<script>
		id("pic");
		var gameUrl = localStorage.getItem("gameLogin");
		pic.style.background = `50% 50%/cover url(games/${gameUrl}/${question.uniqid}.jpg) no-repeat`;
		pic.style.borderBottom = "2px solid black";
	</script>

  <div id="mapContainer" style="position: absolute; top: 0; height: 480px; width: 100%"></div>
	<h2 id="game" style="position: absolute; z-index: 1; top: 8px; left: 16px; margin: 0;"></h2>
	<script>
		id("game");
		game.innerHTML = "Stanoviště "+question.name;
	</script>

	<button id="btnCoords" onclick="setCoords()" style="float: left; margin: .5em">Nastav souřadnice</button>
	<button style="float: right; margin: .5em" onclick="setContent('questions')">Zpět na seznam stanovišť</button>
	<form method="post" id="qForm" onsubmit="event.preventDefault();qUpdate()">
	<script>
		id("qForm");
	</script>

		<input type="hidden" name="uniqid">
		<input type="hidden" name="url">
		<input type="hidden" name="hash">
		<input type="hidden" name="isNew">
		<script>
			qForm.uniqid.value = question.uniqid;
			qForm.url.value = localStorage.getItem("gameLogin");
			qForm.hash.value = localStorage.getItem("gameToken");
			qForm.isNew.value = question.isNew;
		</script>

	  <input type="hidden" name="lat">
	  <input type="hidden" name="lng">
		<script>
	    var coords = +question.lat ? {lat: +question.lat, lng: +question.lng} : MAPdata.coords;
			qForm.lat.value = coords.lat;
			qForm.lng.value = coords.lng;
		</script>

		<input type="number" min="15" max="3000" name="radius" value="30" size="2">
		<script>
			qForm.radius.value = question.radius ? question.radius : 30;
			qForm.radius.style.cssText = "position: absolute; z-index: 1; top: 60px; left: 16px; display: none;";
			qForm.radius.oninput = e => qcircle.setRadius(e.target.value/1000);
		</script>
		<label class="file" id="qFile" style="position: absolute; right: 0; top: 420px; margin: .5em; width: 16em">
	    <input type="file" accept="image/jpeg" name="picture">
	    <span></span>
	    <button>nahraj obrázek</button>
	  </label>
		<script>
			var handler = e => showImage(e).then(data => pic.style.backgroundImage = `url('${data}')`);
			qForm.picture.oninput = handler;
		</script>
		<br clear="all">

		<h3>Otázka</h3>
		<p class="center"><input type="text" name="name" placeholder="Název otázky...">
		<textarea name="question" placeholder="Text otázky..."></textarea>
		<script>
			qForm.name.value = question.name;
			qForm.question.value = question.question;
		</script>

		<h3>Odpověď</h3>
		<input class="folder" id="folderA" type="radio" name="type" value="TEXT" checked>
		<label for="folderA">Textem</label>
		<div>
		<input name="answerText"><a href="#" onclick="event.preventDefault();document.getElementById('help').style.display='block'"><s style="font-size: 2rem">I</s></a><br>
		<div id="help" style="display: none; border: 1px solid black; position: absolute; background: #">
			<a href="#" onclick="event.preventDefault();this.parentNode.style.display='none'" style="float: right; margin: 0 .5rem"><s style="font-size: 2rem">X</s></a>
			<p>Zadejte alternativy oddělené středníkem. Odpověď je vyhodnocena jako správná, pokud text, který zadal hráč, obsahuje některou z alternativ. Vyhodnocení není citlivé na velikost písmen ani na diakritiku.
			<p>Např. <i>Polžíc; Bezdružic</i> znamená správnou odpověď při zadání <i>Polžíce</i>, <i>polzice</i>, <i>Bezdruzice</i> a podobně.
		</div>
		<p>
			<b>Speciální hodnoty</b><br>
			Prázdné pole: bez otázky, objeví se pouze tlačítko pokračovat.<br>
			*: jakákoliv odpověď je přijata jako správná, zobrazí se ve výsledcích.
		</p>
		</div>

		<input class="folder" id="folderB" type="radio" name="type" value="CHOICE">
		<label for="folderB">Výběrem</label>
		<div>
		Napiš hodnoty oddělené středníkem, správné s hvězdičkou na začátku: <input name="answerChoice"><br>
		Nutno vybrat všechny možnosti<br>
		Např.: <i>*jahoda; okurka; *hroznové víno; mrkev; celer</i> vyžaduje volbu <i>jahoda</i> a <i>hroznové víno</i>
		</div>

		<input class="folder" id="folderC" type="radio" name="type" value="NUMBER">
		<label for="folderC">Číslem</label>
		<div>
		Zadejte správnou hodnotu, rozsah či více možností oddělené středníkem: <input name="answerNumber"><br>
		Např.: <i>3; 7-12</i>
		</div>

		<script>
		function createQRcode(tgt) {
		  if(!qrcode.value) qrcode.value = question.uniqid;
		  tgt.src = qrbase(100)+qrcode.value;
		  tgt.parentNode.href = qrbase(300)+qrcode.value;
		  tgt.setAttribute("onload", "");
		}
		</script>
		<input class="folder" id="folderD" type="radio" name="type" value="QRCODE">
		<label for="folderD">QR kódem</label>
		<div>
		<input name="answerQRcode" type="hidden" id="qrcode"><br>
		<a href="#" target="_blank">
		  <img style="float: left; margin-right: 1em" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onload="createQRcode(this)">
		</a>
		<p>Otázka je splněna nalezením a ofocením tohoto QR kódu. Klikni na QR kód pro náhled QR kódu k tisku.
		</div>

		<input class="folder" id="folderE" type="radio" name="type" value="QRMAN">
		<label for="folderE">Člověkem</label>
		<div>
		Napiš středníky oddělené loginy organizátorů: <input name="answerQRman"><br>
		Otázka je splněna ofocením QR kódu, který ve svém rozhraní pro každou transakci zvlášť vygeneruje na svém mobilu organizátor.
		</div>

		<div style="height: 9em"></div>
		<script>
			qForm.type.value = question.type;
			var answer = question.answer;
			switch(question.type) {
				case "TEXT": qForm.answerText.value = answer; break;
				case "CHOICE": qForm.answerChoice.value = answer; break;
				case "NUMBER": qForm.answerNumber.value = answer; break;
				case "QRCODE": qForm.answerQRcode.value = answer; break;
				case "QRMAN": qForm.answerQRman.value = answer; break;
			}
		</script>

		<h3>Nápověda při přesunu ke stanovišti</h3>
		<p>
		<textarea name="transport" placeholder="Nápověda při přesunu ke stanovišti..."></textarea>
		<h3>Nápověda po špatné odpovědi</h3>
		<p>
		<textarea name="hint" placeholder="Nápověda po špatné odpovědi..."></textarea>
		<h3>Text po odpovědi</h3>
		<p>Tento text se hráčům zobrazí po zodpovězení otázky, ať už odpověděli správně, nebo ne.
		<textarea name="after" placeholder="Text po odpovědi..."></textarea>
		<script>
			qForm.transport.value = question.transport;
			qForm.hint.value = question.hint;
			qForm.after.value = question.after;
		</script>

		<p class="center"><button type="button" onclick="qUpdate()">Uložit</button>
	</form>
</div>

<script>
main.style.minHeight = "100vh";

id(["mapContainer","btnCoords","qFile"]);
var qmap, qcircle, mapOn;
function setCoords() {
	if(!qmap) createMap();
	if(!mapOn) {
		mapContainer.style.display = "block";
		qForm.radius.style.display = "block";
		qFile.style.display = "none";
		btnCoords.innerHTML = "Zavři mapu";
		mapOn = true;
	}
	else {
		mapContainer.style.display = "none";
		qForm.radius.style.display = "none";
		qFile.style.display = "block";
		btnCoords.innerHTML = "Nastav souřadnice";
		mapOn = false;
	}
}

function createMap() {
	qmap = new SeznamMapa(mapContainer, coords, 16);
  qcircle = new Circle(qmap.G);
  qcircle.create(coords, qForm.radius.value/1000, "red");
  qmap.click = function(coords) {
    qcircle.setCenter(coords);
    const tgt = fromS(coords);
    qForm.lat.value = tgt.lat;
    qForm.lng.value = tgt.lng;
  }
}

async function qUpdate() {
	await API("setQuestion", new FormData(qForm));

	var fd = new FormData();
	fd.set("game", localStorage.getItem("gameLogin"));
	fd.set("pass", localStorage.getItem("gameToken"));
	var data = await API("getQuestions", fd);

	localStorage.setItem("gameQuestions", data.response);
	questions = JSON.parse(data.response);
	setContent("questions");
}
</script>