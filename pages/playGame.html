<div id="fill">
</div>
<h2 id="h2game"></h2>
<s id="aim" class="icon">T</s>
<s id="hlp" class="icon">I</s>
<s id="arr" class="icon">A</s>
<div id="dist" class="icon">??? m</div>
<button id="save">Uložit</button>
<div id="popup">
<div>
	<div id="popupin"></div>
	<button onclick="this.parentNode.parentNode.style.display='none'">Jasný</button>
</div>
</div>


<script>
id(["h2game","fill","aim","hlp","arr","note","dist","save"]);
var MAP, playerMarker, playerDiv, playerAnim, circle, lastTime=0, helpText, destination;
aim.style.left = "16px";
hlp.style.left = "86px";
arr.style.left = "156px";
arr.style.color = arr.style.borderColor = "black";
dist.style.cssText = "width: 188px; height: 2.5rem; top: 120px; left: 16px; font-size: 2rem; border-radius: .5rem; color: black; border-color: black;";
h2game.style.cssText = "position: absolute; z-index: 1; top: 8px; left: 16px; margin: 0;";
h2game.innerHTML = game.name;
save.style.cssText = "position: absolute; left: 16px; top: 180px; z-index: 1;";

GPS = undefined;
LS.get("G", "qCurrent", 0);
LS.get("G", "qMax", 0);
var gpswatch = pos => {
	GPS = { lat: pos.coords.latitude, lng: pos.coords.longitude};
  var now = new Date();
  const dt = (now - lastTime) / 1000;
	const ds = typeof GPS2 == "undefined" ? 0 : Play.distance(GPS2,GPS) * 1000;
	lastTime = now;
	if(playerMarker) {
		playerMarker.setCoords(toS(GPS));
	  playerAnim.speed = 2 * (ds/dt);
	}
	if(MAP && MAP.pan==false) {
		MAP.M.setCenter(toS(GPS));
	}
	if(GPS && destination) {
	  var dir = Play.azimuth(GPS, destination);
    playerAnim.dir = playerAnim.speed==0 ? 180 : dir;
		arr.style.transform = `rotate(${dir}deg)`;
		var toGo = Play.distance(GPS, destination);
		if(toGo<5) dist.innerHTML = parseInt(toGo*1000)+" m";
		else dist.innerHTML = Math.round(toGo*10)/10+" km";
	}
  var data = G.qCurrent==0 ? game : questions[G.qCurrent];
	if(data && toGo * 1000 <= data.radius) {
		if(data.uniqid) setContent("playQuestion");
		else setContent("playStart");
		gpswatch = _=>_;
	}
	GPS2 = GPS;
}

aim.onclick = function() {
	MAP.pan = false;
  MAP.M.setCenterZoom(toS(GPS),16);
}

hlp.onclick = function() {
	var container = popup.querySelector("div#popupin");
	popup.style.display = "flex";
	if(G.qCurrent==0) container.innerHTML = "Dojdi do červeného kruhu na mapě, odkud hra započne.";
	else container.innerHTML = questions[G.qCurrent].hint || Texts.song;
}

save.onclick = function() {
	LS.set("G", "saved", -1);
	LS.set("G", "lat", GPS.lat);
	LS.set("G", "lng", GPS.lng);
	setContent("homeUser");
}

var loadMap1 = function() {
	if(typeof GPS == "undefined") return setTimeout(loadMap1, 100);
	if(typeof Loader == "undefined") return setTimeout(loadMap1, 100);
	if(typeof SeznamMapa == "undefined") return setTimeout(loadMap1, 100);
	Loader.load();
	loadMap2();
}
var loadMap2 = function() {
	try { MAP = new SeznamMapa(fill,GPS); }
	catch(e) { return setTimeout(loadMap2,200); }
	circle = new Circle(MAP.G);
	circle.create(GPS, 0.03, "red");
  playerDiv = ElemFromText(`<div id="player"></div>`)
	playerMarker = Marker(MAP.P, toS(GPS), playerDiv);
	playerAnim = new Sprite(playerDiv);
	loadAim();
}
loadMap1();


var loadAim = function() {
	var data = G.qCurrent==0 ? game : questions[G.qCurrent];
	circle.setCenter(destination={lat:+data.lat, lng:+data.lng});
	circle.setRadius(+data.radius/1000);
	h2game.innerHTML = data.uniqid ? `Stanoviště ${G.qCurrent}/${G.qMax}` : `Cesta na začátek`;
}
</script>