<script>
    if(!LS.get("G", "game")) setContent("home");
    LS.get("G", "nextLoc", 0);
</script>

<div id="mapContainer" style="width: 100vw; height: 100vh"></div>
<script>
GPS = GPS2 = undefined;
STATIC.lastTime = 0;
STATE.gpswatch = pos => {
    GPS = { lat: pos.coords.latitude, lng: pos.coords.longitude};
    var now = new Date();
    const dt = (now - STATIC.lastTime) / 1000;
    const ds = GPS2===undefined ? 0 : Play.distance(GPS2,GPS) * 1000;
    STATIC.lastTime = now;
    if(STATIC.playerMarker) {
        STATIC.playerMarker.setCoords(toS(GPS));
        STATIC.playerAnim.speed = 2 * (ds/dt);
    }
    if(G.MAP && G.MAP.pan==false) {
    	G.MAP.M.setCenter(toS(GPS));
    }
    if(GPS && STATIC.destination) {
        var dir = Play.azimuth(GPS, STATIC.destination);
        STATIC.playerAnim.dir = STATIC.playerAnim.speed==0 ? 180 : dir;
    	ID.arr.style.transform = `rotate(${dir}deg)`;
    	var toGo = Play.distance(GPS, STATIC.destination);
    	if(toGo<5) dist.innerHTML = parseInt(toGo*1000)+" m";
    	else dist.innerHTML = Math.round(toGo*10)/10+" km";
    }
    var data = G.nextLoc<1 ? G.game : G.questions[G.nextLoc];
    if(data && toGo * 1000 <= data.radius) {
    	if(data.uniqid) setContent("playQuestion");
    	else setContent("playStart");
    	gpswatch = _=>_;
    }
    GPS2 = GPS;
}

var loadMap1 = function() {
    if(typeof GPS == "undefined") return setTimeout(loadMap1, 100);
    if(typeof Loader == "undefined") return setTimeout(loadMap1, 100);
    if(typeof SeznamMapa == "undefined") return setTimeout(loadMap1, 100);
    Loader.load();
    loadMap2();
}
var loadMap2 = function() {
    try { G.MAP = new SeznamMapa(ID.mapContainer, GPS); }
    catch(e) { return setTimeout(loadMap2, 200); }
    var playerDiv = ElemFromText(`<div id="player"></div>`)
    STATIC.playerMarker = Marker(G.MAP.P, toS(GPS), playerDiv);
    STATIC.playerAnim = new Sprite(playerDiv);
    STATIC.circle = new Circle(G.MAP.G);
    STATIC.circle.create(GPS, 0.03, "red");
    loadAim();
}
var loadAim = function() {
	var data = G.nextLoc<=0 ? G.game : G.questions[G.nextLoc];
	STATIC.circle.setCenter(STATIC.destination={lat:+data.lat, lng:+data.lng});
	STATIC.circle.setRadius(+data.radius/1000);
	ID.h2game.innerHTML = data.uniqid ? `Stanoviště ${G.nextLoc}/${G.questions.length}` : `Cesta na začátek`;
}
loadMap1();
</script>

<h2 id="h2game"></h2>
<script>
    ID.h2game.style.cssText = "position: absolute; z-index: 1; top: 8px; left: 16px; margin: 0;";
    ID.h2game.innerHTML = G.game.name;
</script>


<s id="aim" class="icon">T</s>
<s id="hlp" class="icon">I</s>
<s id="arr" class="icon">A</s>
<script>
    ID.aim.style.left = "16px";
    ID.hlp.style.left = "86px";
    ID.arr.style.left = "156px";
    ID.arr.style.color = arr.style.borderColor = "black";

    ID.aim.onclick = function() {
        G.MAP.pan = false;
        G.MAP.M.setCenterZoom(toS(GPS),16);
    }

    ID.hlp.onclick = function() {
    	var container = popup.querySelector("div#popupin");
    	popup.style.display = "flex";
    	if(G.nextLoc==0) container.innerHTML = "Dojdi do červeného kruhu na mapě, odkud hra započne.";
    	else container.innerHTML = G.questions[G.nextLoc].hint || Texts.song;
    }
</script>

<div id="dist" class="icon">??? m</div>
<!-- odkomentovat po implementaci ukládání
<button id="save">Uložit</button>
-->
<script>
    ID.dist.style.cssText = "width: 188px; height: 2.5rem; top: 120px; left: 16px; font-size: 2rem; border-radius: .5rem; color: black; border-color: black;";
/*
    ID.save.style.cssText = "position: absolute; left: 16px; top: 180px; z-index: 1;";

    ID.save.onclick = function() {
    	setContent("homeUser");
    }
*/
</script>

<div id="popup">
<div>
	<div id="popupin"></div>
	<button onclick="this.parentNode.parentNode.style.display='none'">Jasný</button>
</div>
</div>
