<script>
/*
    MESSAGE: map (mapa pro kreslení změn, přejatá z homeGame)
*/
    if(!message.map) setContent("homeGame");
    if(!LS.get("E","login") || !LS.get("E","token")) setContent("home");
    E.clickMovesCircle = false;
    main.style.minHeight = "100vh";
    if(!E.sMap) STATE.abort = true;
</script>

<div class="center">
	<div id="mapContainer"></div>
	<h2 id="game"></h2>
	<s id="aim">T</s>
</div>
<script>
ID.game.style.cssText = "position: absolute; z-index: 1; top: 8px; left: 16px; margin: 0;";
ID.aim.style.cssText = "position: absolute; z-index: 1; top: 60px; left: 16px; width: 1em; height: 1em; font-size: 2em; border-radius: 2em; padding: 2px 2px 0 2px; cursor: pointer; color: var(--linkcolor); border: 2px solid var(--linkcolor); background: white";
ID.game.innerHTML = "Hra "+E.login;
ID.mapContainer.appendChild(message.map);

ID.aim.onclick = function() {
    E.mapPan = false;
    E.sMap.M.setCenterZoom(toS(E.coords),16);
}
</script>

<form id="explForm" onsubmit="event.preventDefault();addQuestion()">
    <input type="hidden" name="lat" id="lat">
    <input type="hidden" name="lng" id="lng">
    <script>
    var update = function(pos) {
        E.mapCoords = {lng: pos.coords.longitude, lat: pos.coords.latitude};
        ID.explForm.lat.value = E.mapCoords.lat;
        ID.explForm.lng.value = E.mapCoords.lng;
        if(!E.mapPan) E.sMap.M.setCenter(toS(E.mapCoords));
        E.mapCircle.setCenter(E.mapCoords);
    }

    var gpsid;
    STATE.load.push(_=> gpsid = navigator.geolocation.watchPosition(update, console.error, {
      enableHighAccuracy: true,
      timeout: 5000,
      maximumAge: 0
    }));

    STATE.unload.push(_ => navigator.geolocation.clearWatch(gpsid));
    </script>

    <input type="text" name="name" placeholder="Název stanoviště...">
    <button>Vyfoť</button>
    <button type="button" onclick="setContent('homeGame')">Zpět ke hře</button>
</form>
<script>
function addQuestion() {
	setContent("capture", {back: "explorer", oncapture: captureHandler});
}

function captureHandler(blob) {
	var fd = new FormData(ID.explForm);
	fd.append("photo", blob);
	fd.append("url", E.login);
	fd.append("hash", E.token);
	API("explForm", fd).then(data => editQuestion(data.response));
}

async function editQuestion(data) {
	if(!data) return;
	data = JSON.parse(data);
	data.answer = data.after = data.hint = data.question = data.transport = "";
	data.url = E.login;
	E.questions.push(data);
    setContent("question", {quid: data.uniqid});
}
</script>
